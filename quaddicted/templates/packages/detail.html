{% extends "packages/base.html" %}

{% load static %}
{% load comments %}

{% block content %}

<section class="row">
	<div class="col">
		<h1 class="title is-1">{{ package }}</h1>
	</div>
</section>

<!-- screenshot carousel -->
<section class="row">
	<div class="col">
		<div id="screenshots" class="carousel slide carousel-fade mb-3">
			<ol class="carousel-indicators">
				{% if package.screenshots.count > 1 %}
					{% for x in package.screenshots.all %}
				<li data-target="#screenshots"
				    data-slide-to="{{ forloop.counter0 }}"
				    {% if forloop.first %}class="active"{% endif %}>
				</li>
					{% endfor %}
				{% endif %}
			</ol>
			<div class="carousel-inner">
			{% for x in package.screenshots.all %}
				<div class="carousel-item{% if forloop.first %} active{% endif %} bg-dark" style="max-height: 576px">
					<img src="/media/{{ x }}" class="d-block m-auto" style="max-height: 576px">
				</div>
			{% empty %}
				<div class="carousel-item active">
					<img src="{% static '/1024x576.png' %}" class="d-block w-100">
				</div>
			{% endfor %}
			</div>

			{% if package.screenshots.count > 1 %}
			<a class="carousel-control-prev"
			   href="#screenshots"
			   role="button"
			   data-slide="prev">
				<span class="carousel-control-prev-icon" aria-hidden="true"></span>
				<span class="sr-only">Previous</span>
			</a>
			<a class="carousel-control-next"
			   href="#screenshots"
			   role="button"
			   data-slide="next">
				<span class="carousel-control-next-icon" aria-hidden="true"></span>
				<span class="sr-only">Next</span>
			</a>
			{% endif %}
		</div>
	</div>
</section>


<div class="row">
	<!-- left column -->
	<div class="col-lg-8">
		<!-- package listing details -->
		<section class="card mb-3">
			<h5 class="card-header">{{ package.name }}</h5>
			<div class="card-body">
				<dl class="row">
					<dt class="col-md-4">Authors</dt>
					<dd class="col-md-8 text-right">
					{% for author in package.authors.all %}
						<a href="{% url 'packages:list' %}?author={{ author.id }}" title="Show only this users packages">{{ author }}</a>{% if not forloop.last %}, {% endif %}
					{% endfor %}
					</dd>

					<dt class="col-sm-4">Created</dt>
					<dd class="col-sm-8 text-right"><time datetime="{{ package.created }}">{{ package.created }}</time></dd>

				{%  if package.modified %}
					<dt class="col-sm-4">Modified</dt>
					<dd class="col-sm-8 text-right"><time datetime="{{ package.modified }}">{{ package.modified }}</time></dd>
				{%  endif %}

				{% if package.urls.all %}
					<dt class="col-sm-4">Additional Links</dt>
					<dd class="col-sm-8 text-right">
						<ul class="list-unstyled mb-0">
						{% for u in package.urls.all %}
							<li><a href="{{ u.url }}">{{ u.name }}</a></li>
						{% endfor %}
						</ul>
					</dd>
				{% endif %}

					<dt class="col-sm-4">Type</dt>
					<dd class="col-sm-8 text-right">{{ package.map_type|default:'map'|capfirst }}</dd>
				</dl>

				<div class="text-right">
					<a class="btn btn-primary" href="{{ package.file.url }}">Download</a>
					<a class="btn bg-danger text-white" href=""><span class="icon"><i class="fas fa-flag"></i></span></a>
				</div>
			</div>
		</section>

		<!-- package description -->
		<section class="card mb-3">
			<h5 class="card-header">Description</h5>
			<div class="card-body">{% lorem p %}</div>
		</section>

		<!--
			Comments
		-->
		<section class="card mb-3 package-comments" id="comments">
			<h5 class="card-header">Comments</h5>
			<div class="card-body">
				<div class="row">
					<div class="col-sm-2"></div>
					<div class="col-sm-10">
					{% get_comment_form for package as form %}
						<form action="{% comment_form_target %}" method="POST">
						{% csrf_token %}
						{% if not user.is_authenticated %}
							<div class="form-group">
								<label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
								<input type="text"
								       class="form-control"
								       id="{{ form.name.id_for_label }}"
								       name="{{ form.name.html_name }}"
								       maxlength="32"
								       value="{% if form.name.value %}{{ form.name.value }}{% endif %}">
							</div>
						{% endif %}
							<div class="form-group">
								<label for="{{ form.comment.id_for_label }}">{{ form.comment.label }}</label>
								<textarea class="form-control"
								          id="{{ form.comment.id_for_label }}"
								          name="{{ form.comment.html_name }}"
								          rows="3">{% if form.comment.value %}{{ form.comment.value }}{% endif %}</textarea>
							</div>
							<div class="d-none">{{ form.honeypot }}</div>
							{{ form.content_type }}
							{{ form.object_pk }}
							{{ form.timestamp }}
							{{ form.security_hash }}
							<input type="hidden" name="next" value="{% url 'packages:detail' package.file_hash %}#comments" />
							<button type="submit" class="btn btn-primary mb-2">Add comment</button>
						</form>
					</div>
				</div>

			{% get_comment_list for package as comments %}
			{% for comment in comments reversed %}
				<article class="row mb-3" id="c{{ comment.id }}">
					<div class="col-sm-2">
						<img class="img-thumbnail img-responsive user-photo" src="{% static 'avatar_2x.png' %}">
					</div>

					<div class="col-sm-10">
						<div class="card">
							<div class="card-header">
								<strong>{{ comment.user_name }}</strong>
								<time class="text-muted small" datetime="{{ comment.submit_date }}">commented <a href="#{{ comment.id }}">{{ comment.submit_date|timesince }} ago</a></time>
								<span class="text-muted float-right">
									{% for s in '   ' %}
									<i class="text-warning fa fa-star"></i>
									{% endfor %}
								</span>
							</div>
							<div class="card-body">
								{{ comment.comment }}

								<div class="text-right text-sm">
									<a class="btn bg-danger btn-sm text-white" href="/comments/flag/{{ comment.id }}/"><span class="icon"><i class="fas fa-exclamation-circle"></i></span></a>
									<a class="btn bg-danger btn-sm text-white" href="/comments/flag/{{ comment.id }}/"><span class="icon"><i class="fas fa-trash"></i></span></a>
								</div>
							</div>
						</div>
					</div>
				</article>
			{% endfor %}

			</div>
		</section>
	</div>

	<!-- right column -->
	<div class="col-lg-4">
		<section class="card mb-3">
			<h5 class="card-header">Rating</h5>
			<div class="card-body">
				<dl class="row">
					<dt class="col-sm-4">Average</dt>
					<dd class="col-sm-8 text-right">
					{% if package.rating|default:4 %}
					{%  for n in "    " %}
						<span class="icon"><i class="fas fa-heart"></i></span>
					{%  endfor %}
						<noscript>{{ package.rating }}</noscript>
					{% endif %}
					</dd>

					<dt class="col-sm-4">You</dt>
					<dd class="col-sm-8 text-right">
					{% if package.rating|default:4 %}
					{%  for n in "   " %}
						<span class="icon"><i class="fas fa-heart"></i></span>
					{%  endfor %}
						<noscript>{{ package.rating }}</noscript>
					{% endif %}
					</dd>
				</dl>
			</div>
		</section>

		<section class="card mb-3">
			<h5 class="card-header">Tags</h5>
			<div class="card-body">
				<p>
				{% for tag in package.tags.all %}
					<a class="btn btn-light btn-sm mb-1" href="{% url 'packages:list' %}?tag={{ tag.id }}">{{ tag }}</a>
				{% endfor %}
					<a href="" class="btn btn-light btn-sm mb-1" title="Suggest a new tag">
						<i class="fas fa-plus"></i>
					</a>
				</p>
			</div>
		</section>

		<section class="card">
			<h5 class="card-header">Demos</h5>
			<div class="card-body">
				{% if package.demos %}
				<table class="table table-sm">
					<thead>
						<tr>
							<th>Player</th>
							<th>Skill</th>
							<th>Length</th>
							<th>Protocol</th>
							<th>Date</th>
						</tr>
					</thead>
					<tbody>
				{% for demo in package.demos.all %}
						<tr>
							<td>{{ demo.player }}</td>
							<td>{{ demo.skill }}</td>
							<td>{{ demo.length }}</td>
							<td>{{ demo.protocol }}</td>
							<td>{{ demo.date|date:'Y-m-d' }}</td>
						</tr>
				{% endfor %}
					</tbody>
				</table>
				{% else %}
				<p>No demos</p>
				{% endif %}

				{% if user.is_authenticated %}
				<form action="" method="POST">
					<div class="form-group">
						<label for="id_demo_skill">Skill</label>
						<select class="form-control" id="id_demo_skill" name="demo_skill">
							<option value="0">Easy</option>
							<option value="1">Normal</option>
							<option value="2">Hard</option>
							<option value="3">Nightmare</option>
						</select>
					</div>
					<div class="form-group">
						<label for="id_demo_file">Demo (.dz) file</label>
						<input type="file" class="form-control-file" id="id_demo_file" name="demo_file">
					</div>

					<button type="submit" class="btn btn-primary mb-2">Upload demo</button>
				</form>
				{% endif %}
			</div>
		</section>

	{% if package.package %}
		<section class="card">
			<h5 class="card-header">Files</h5>
			<div class="card-body">
				<table class="table table-sm">
					<thead>
						<tr>
							<th>File</th>
							<th>Size</th>
							<th>Date</th>
						</tr>
					</thead>
					<tbody>
				{% for file in package.files.all %}
						<tr>
							<td>{{ file.name }}</td>
							<td>{{ file.size }}</td>
							<td>{{ file.timestamp|date:'Y-m-d' }}</td>
						</tr>
				{% endfor %}
					</tbody>
				</table>
			</div>
		</section>
	{% endif %}
	</div>
</div>

{% endblock %}

{% block javascript %}
	<script>
		$('.carousel').carousel();
	</script>
{% endblock %}